{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/team_detail.css' %}" />
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

</head>
<body>

    {% include "components/header.html" %}

    <main class="container">
        <h1 class="team-name">{{ team.name }}</h1>

        <section class="member-section">
            <ul class="member-list">
                {% for member in members %}
                    {% with is_leader=member.user_id|yesno:"" %}
                    {% endwith %}
                
                    {% if member.user_id == team.owner_id %}
                        {% with is_leader=True %}
                            <li class="member-item leader">
                                <div class="member-info">
                                    <i class="fa-solid fa-trophy notification-icon"></i>
                                    <span class="owner-name">{{ member.user.display_name }}</span>
                                </div>
                            </li>
                        {% endwith %}
                
                    {% else %}
                        <li class="member-item">
                            <div class="member-info">
                                <span class="member-name">{{ member.user.display_name }}</span>
                            </div>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>

            {% if members|length < team.max_members %}
            <div class="actions">
                <button type="button" class="btn-add" id="openInviteModal">
                    招待コードを表示
                </button>
            </div>
        {% endif %}
    </section>

    {% if invite and invite.is_active %}
    <div id="inviteModal" class="modal" aria-hidden="true">

        <div class="modal-panel" role="dialog" aria-modal="true" aria-label="招待コード">

            <button type="button" class="modal-close" id="closeInviteModal" aria-label="閉じる">×</button>
            
            <div class="modal-title">招待コード</div>
            
            <div class="invite-row">
                <div class="invite-code-text" id="inviteCodeText">{{ invite.code }}</div>
                <button type="button" class="copy-btn" id="copyInviteCode" aria-label="コピー">
                    <i class="fa-regular fa-copy"></i>
                </button>
            </div>
        </div>
    </div>
    {% endif %}


    {% if invite and invite.is_active %}
        <section class="actions">
            {% if request.user.id == team.owner_id %}
                <form method="post" action="{% url 'teams:invite_regenerate' team.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-regenerate">招待コードを再生成</button>
                </form>
            {% endif %}
        </section>
    {% endif %}

    <section class="danger-zone">
        {% if request.user.id == team.owner_id %}
            <form method="post" action="{% url 'teams:dissolve' team.id %}"
                onsubmit="return confirm('本当にチームを解散しますか？この操作は取り消せません。');">
                {% csrf_token %}
                <button type="submit" class="btn-delete">チームを解散</button>
            </form>
        {% endif %}
    </section>
        
    </main>

    {% include "components/footer.html" %}

    <script>
(function () {
    const modal = document.getElementById('inviteModal');
    const openBtn = document.getElementById('openInviteModal');
    const closeBtn = document.getElementById('closeInviteModal');
    const copyBtn = document.getElementById('copyInviteCode');
    const codeEl = document.getElementById('inviteCodeText');

    if (!modal || !openBtn) return;

    function openModal() {
        modal.style.display = 'flex';
        modal.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
    }

    function closeModal() {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('modal-open');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);

    // 背景クリックで閉じる（パネル外）
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // ESCで閉じる
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    // コピー
    copyBtn && copyBtn.addEventListener('click', async () => {
        try {
        const text = codeEl ? codeEl.textContent.trim() : '';
        await navigator.clipboard.writeText(text);
        copyBtn.classList.add('copied');
        setTimeout(() => copyBtn.classList.remove('copied'), 700);
    } catch (err) {
        // クリップボードが使えない環境向けフォールバック
        const text = codeEl ? codeEl.textContent.trim() : '';
        window.prompt('コピーできない場合は手動でコピーしてください:', text);
    }
    });
})();
</script>

</body>
</html>